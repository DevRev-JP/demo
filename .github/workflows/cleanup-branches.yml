name: Branch Cleanup
on:
  pull_request:
    types: [closed]
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode (show what would be deleted)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
  schedule:
    # æ¯Žé€±æ—¥æ›œæ—¥ 2AM UTC ã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Ÿè¡Œ
    - cron: '0 2 * * 0'

permissions:
  contents: read
  pull-requests: read

jobs:
  cleanup-merged-branches:
    name: Clean up merged branches
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Clean up merged branches
        run: |
          echo "ðŸ§¹ Starting branch cleanup..."

          # DRY_RUN ãƒ¢ãƒ¼ãƒ‰è¨­å®š
          DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"

          # ä¿è­·ãƒ–ãƒ©ãƒ³ãƒå®šç¾©
          PROTECTED_BRANCHES="main develop master"

          # ãƒªãƒ¢ãƒ¼ãƒˆã®æœ€æ–°æƒ…å ±ã‚’å–å¾—
          git fetch --all --prune

          echo "ðŸ“‹ Protected branches: $PROTECTED_BRANCHES"
          echo "ðŸ” Dry run mode: $DRY_RUN"
          echo

          # ãƒžãƒ¼ã‚¸æ¸ˆã¿ãƒ–ãƒ©ãƒ³ãƒã‚’æ¤œå‡º
          MERGED_BRANCHES=$(git branch -r --merged origin/develop | \
            grep -v "origin/develop" | \
            grep -v "origin/main" | \
            grep -v "origin/master" | \
            grep -v "origin/HEAD" | \
            sed 's/origin\///' | \
            tr -d ' ')

          if [ -z "$MERGED_BRANCHES" ]; then
            echo "âœ… No merged branches found to clean up"
            exit 0
          fi

          echo "ðŸ—‘ï¸  Found merged branches to clean up:"
          for branch in $MERGED_BRANCHES; do
            echo "  - $branch"
          done
          echo

          # ãƒ–ãƒ©ãƒ³ãƒå‰Šé™¤å®Ÿè¡Œ
          for branch in $MERGED_BRANCHES; do
            # ä¿è­·ãƒ–ãƒ©ãƒ³ãƒã‹ãƒã‚§ãƒƒã‚¯
            is_protected=false
            for protected in $PROTECTED_BRANCHES; do
              if [ "$branch" = "$protected" ]; then
                is_protected=true
                break
              fi
            done

            if [ "$is_protected" = true ]; then
              echo "ðŸ”’ Skipping protected branch: $branch"
              continue
            fi

            # feature/ hotfix/ bugfix/ ã§å§‹ã¾ã‚‹ãƒ–ãƒ©ãƒ³ãƒã®ã¿å‰Šé™¤
            if [[ "$branch" =~ ^(feature|hotfix|bugfix)/ ]]; then
              if [ "$DRY_RUN" = "true" ]; then
                echo "ðŸ” [DRY RUN] Would delete: $branch"
              else
                echo "ðŸ—‘ï¸  Deleting: $branch"
                if git push origin --delete "$branch" 2>/dev/null; then
                  echo "âœ… Successfully deleted: $branch"
                else
                  echo "âš ï¸  Failed to delete: $branch (may already be deleted)"
                fi
              fi
            else
              echo "â­ï¸  Skipping non-feature branch: $branch"
            fi
          done

          echo
          if [ "$DRY_RUN" = "true" ]; then
            echo "ðŸ” Dry run completed - no branches were actually deleted"
          else
            echo "âœ… Branch cleanup completed"
          fi

  cleanup-notification:
    name: Notify cleanup results
    runs-on: ubuntu-latest
    needs: cleanup-merged-branches
    if: always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')

    steps:
      - name: Create cleanup summary
        run: |
          echo "## ðŸ§¹ Branch Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ needs.cleanup-merged-branches.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.cleanup-merged-branches.result }}" = "success" ]; then
            echo "âœ… Cleanup completed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Cleanup encountered issues" >> $GITHUB_STEP_SUMMARY
          fi